# Auto Encrypt

Automatically provisions and renews [Let‚Äôs Encrypt](https://letsencrypt.org) TLS certificates on [Node.js](https://nodejs.org) [https](https://nodejs.org/docs/latest-v24.x/api/https.html) servers. As used in [@small-tech/https](https://codeberg.org/small-tech/https) and [Kitten](https://kitten.small-web.org).

Implements the subset of RFC 8555 ‚Äì Automatic Certificate Management Environment (ACME) ‚Äì necessary for a client to support TLS certificate provisioning from Let‚Äôs Encrypt using HTTP-01 challenges.

## How it works

Let‚Äôs Encrypt TLS certificates are automatically provisioned for you before your server starts.

Auto Encrypt uses the new Let‚Äôs Encrypt `shortlived` profile *exclusively*,  which means certificates are valid for (and renewed before) 160 hours. This should occur at around the 80 hour mark of the certificate‚Äôs lifespan, in accordance with data returned by ACME Renewal Information (ARI).

Auto Encrypt also implements automatic support for obtaining certificates on IPv4 and IPv6 addresses to enable the use of [Web Numbers](https://ar.al/2025/06/25/web-numbers/) on the Small Web.

When not provisioning certificates, Auto Encrypt also forwards HTTP calls to HTTPS on your server.

## Compatibility

Node.js 18.20.0+ on Linux and macOS.

All tests pass on Node.js LTS (version 24).

> üí° The module was tested to run on Windows 10 & 11 but it is no longer supported on Windows as  [Microsoft is complicit in Israel‚Äôs genocide of the Palestinian people](https://www.bdsmovement.net/microsoft) and [Small Technology Foundation](https://small-tech.org/) stands in solidarity with the [Boycott, Divestment, and Sanctions (BDS) movement](https://www.bdsmovement.net/). **Windows is an ad-infested and surveillance-ridden dumpster fire of an operating system and, alongside supporting genocide, you are putting both yourself and others at risk by using it.** 
>
> üáµüá∏ To support families facing genocide in Gaza, consider [donating to them via Gaza Verified](https://gaza-verified.org/donate/).

## Installation

```sh
npm i @small-tech/auto-encrypt
```

## Usage

### Instructions

1. Import the module:

   ```js
   import AutoEncrypt from '@small-tech/auto-encrypt'
   ```

2. Create your server:

    ```js
    // const server = https.createServer(‚Ä¶) becomes
    const server = await AutoEncrypt.https.createServer(‚Ä¶)
    ```

    > üí° Auto Encrypt supports _one_ server per Node process. If you call `createServer()` again, any arguments you pass will be ignored and your will get the same server back. To create another server in the same process (e.g., when testing), call `await server.close()` first (see below) and then create the new server.

3. When done, close your server:

    ```js
    await server.close()
    console.info ('The server is now closed.')
    ```

### Example

The following code creates an HTTPS server running on port 443 that automatically provisions and renews TLS certificates from [Let‚Äôs Encrypt](https://letsencrypt.org) for the domains _&lt;hostname&gt;_.

```js
import AutoEncrypt from '@small-tech/auto-encrypt'

const server = await AutoEncrypt.https.createServer((_request, response) => {
  response.end('Hello, world')
})

await server.listen()

const domain = os.hostname()
console.info(`Auto-encrypted HTTPS server is running at ${domain}.`)

try {
  const response = await fetch(`https://${domain}/`)
  const responseText = await response.text()
  console.info('Server says:', responseText)
} catch (error) {
  console.error(error)
}

await server.close()
console.info ('The server is now closed.')
```

Note that on Linux, ports 80 and 443 require special privileges. Please see [A note on Linux and the security farce that is ‚Äúprivileged ports‚Äù](#a-note-on-linux-and-the-security-farce-that-is-priviliged-ports). If you just need a [Small Web](https://ar.al/2024/06/24/small-web-computer-science-colloquium-at-university-of-groningen/) server that handles all that and more for you (or to see how to implement privilege escalation seamlessly in your own servers, see [Kitten](https://kitten.small-web.org)).

## Configuration

You can customise the default configuration by adding Auto Encrypt-specific options to the options object you pass to the Node `https` server.

You can specify the domains you want the certificate to support, whether the Let‚Äôs Encrypt staging server or a local [Pebble](https://github.com/letsencrypt/pebble) server should be used instead of the default production server (useful during development and testing), and to specify a custom settings path for your Let‚Äôs Encrypt account and certificate information to be stored in.

You can also set the `ipv4` flag to `true` to make Auto Encrypt auto-detect your external IPv4 address (using https://ip.small-web.org/) and provision a certificate for it.

Similarly, you can set the `ipv6` flag to `true` to make Auto Encrypt auto-detect stable IPv6 addresses on your machine (this is done locally) and provision certificates for them.

If you pass `ipOnly: true`, then certificates will only be provisioned for IP addresses. This turns off the automatic provisioning of certificates for the machine‚Äôs hostname and overrides any domains you may have passed in the `domains` array.

(Auto Encrypt uses [Node Pebble](https://codeberg.org/small-tech/node-pebble) to enable testing with a local Pebble server from Node.js.)

### Example

```js
import AutoEncrypt from '@small-tech/auto-encrypt'

const options = {
  // Regular HTTPS server and TLS server options, if any, go here.

  // Optional Auto Encrypt options:
  ipv4: true,
  ipOnly: true,
  server: AutoEncrypt.server.STAGING,
  settingsPath: '/custom/settings/path'
}

// Pass the options object to https.createServer()
const server = await AutoEncrypt.https.createServer(options, listener)

// ‚Ä¶
```

### Default options

Here is the full list of Auto Encrypt options (all optional) and their defaults:

- `domains`: the hostname of the current computer and the www subdomain at that hostname.
- `server`: it will use the production server (which has [rate limits](https://letsencrypt.org/docs/rate-limits/)). Valid values are `AutoEncrypt.server.(PEBBLE|STAGING|PRODUCTION)`.
- `settingsPath`: _~/.small-tech.org/auto-encrypt/_
- `ipv4`: true/false ‚Äì whether or not to automatically detect external IPv4 address and add it to the TLS certificate being provisioned.
- `ipv6`: true/false ‚Äì whether or not to automatically detect stable IPv6 addresses and add them to the TLS certificate being provisioned.
- `ipOnly`: When true, the machines hostname is not added to the TLS certificate and neither are the domains passed in the `domains` array, if any.

## Making a graceful exit

When you‚Äôre ready to exit your app, just call the `await server.close()` method. This will allow Auto Encrypt to perform housekeeping like shutting own the HTTP server that is used for answering Let‚Äôs Encrypt challenges as well as performing HTTP to HTTPS redirections and to destroy its certificate check update interval which, if not destroyed, will prevent your app from exiting.

## Developer documentation

If you want to help improve Auto Encrypt or better understand how it is structured and operates, please see the [developer documentation](https://codeberg.org/small-tech/auto-encrypt/src/branch/main/developer-documentation.md).

### Express.js example

```js
const express = require('express')
import AutoEncrypt from '@small-tech/auto-encrypt'

const app = express()
app.get('/', (request, response) => {
  response.end('Hello, world!')
})

const myDomain = 'dev.ar.al'
const server = await AutoEncrypt.https.createServer(
  { domains: [myDomain] },
  app
)

await server.listen()
console.log(`Auto-encrypted Express server is running at https://${myDomain}`)

// Later‚Ä¶
await server.close()
console.info ('The server is now closed.')
```

## Like this? Fund us!

[Small Technology Foundation](https://small-tech.org) is a tiny, independent not-for-profit.

We exist in part thanks to patronage by people like you. If you share [our vision](https://small-tech.org/about/#small-technology) and want to support our work, please [become a patron or donate to us](https://small-tech.org/fund-us) today and help us continue to exist.

## Audience

This is [small technology](https://small-tech.org/about/#small-technology).

If you‚Äôre evaluating this for a ‚Äústartup‚Äù or an enterprise, let us save you some time: this is not the right tool for you. This tool is for individual developers to build personal web sites and apps for themselves and for others in a non-colonial manner that respects the human rights of the people who use them.

## Client details

Auto Encrypt does one thing and one thing well: it automatically provisions a Let‚Äôs Encrypt TLS certificate for your Node.js https servers using the HTTP-01 challenge method when your server is first hit from its hostname, and automatically renews your certificate thereafter. When not provisioning certificates, it forwards any HTTP requests that your machine gets to HTTPS.

__Auto Encrypt _does not_ and _will not:___

- __Implement wildcard certificates.__ For most [small tech](https://small-tech.org/about/#small-technology) needs (personal web sites and web apps), you will likely need no more than two domains (the root domain and, due to historic and conventional reasons, the www subdomain). You will definitely not need more than the 100 domains that are supported per certificate. If you do, chances are you are looking to use Auto Encrypt in a startup or corporate setting, which is not what its for.

- __Implement DNS-01__ or any other methods that cannot be fully automated.

## Staging and production server behaviour and rate limits

By default, Auto Encrypt uses Let‚Äôs Encrypt‚Äôs production environment. This is most likely what you want as it means your HTTPS server will Just Work‚Ñ¢, i.e., provision its TLS certificate automatically the first time the server is hit via its hostname and from thereon automatically renew the certificate a month ahead of its expiry date.

However, be aware that the production server has [rate limits](https://letsencrypt.org/docs/rate-limits/).

For testing, Auto Encrypt provides seamless support for using the included local Pebble server or the Let‚Äôs Encrypt staging server.

If you do use the staging environment, be aware that browsers will reject the staging certificates unless you trust the [Fake LE Root X1 certificate](https://letsencrypt.org/docs/staging-environment/#root-certificate). If testing with an external https client written in Node, you can add the fake root certificate to your trust store temporarily, using the [`NODE_EXTRA_CA_CERTS` environment variable](https://nodejs.org/api/cli.html#cli_node_extra_ca_certs_file) or setting the `ca` options property when creating your `https` server. (Note that if you‚Äôre testing with the staging or Pebble server from the same process that Auto Encrypt is running in, Auto Encrypt automatically does this for you by monkeypatching Node‚Äôs TLS module with the necessary CA certificates.)

Needless to say, do not add the fake certificate root to the same trust store you use for your everyday browsing.

## Related projects

From lower-level to higher-level:

### Auto Encrypt Localhost

- Source: https://codeberg.org/small-tech/auto-encrypt-localhost
- Package: [@small-tech/auto-encrypt-localhost](https://www.npmjs.com/package/@small-tech/auto-encrypt-localhost)

Automatically provisions and installs locally-trusted TLS certificates for Node.js https servers in 100% JavaScript (without any native dependencies like mkcert and certutil).

### HTTPS

- Source: https://source.small-tech.org/site.js/lib/https
- Package: [@small-tech/https](https://www.npmjs.com/package/@small-tech/https)

Drop-in replace for the [standard Node.js HTTPS module](https://nodejs.org/dist/latest-v12.x/docs/api/https.html) replacement that automatically handles TLS certificate provisioning and renewal both at localhost (via Auto Encrypt Localhost) and at hostname (via Auto Encrypt).

### Kitten

- Site: https://kitten.small-web.org
- Source: https://codeberg.org/kitten/app

A [üíï Small Web](https://ar.al/2020/08/07/what-is-the-small-web/) development kit.

## Tests and coverage

This project aims for > 80% coverage and currently has > 90%.

To see the current state of code coverage, run `npm run coverage`.

For more details, please see the [developer documentation](https://codeberg.org/small-tech/auto-encrypt/src/branch/main/developer-documentation.md#tests).

## A note on Linux and the security farce that is ‚Äúprivileged ports‚Äù

Linux has an outdated feature dating from the mainframe days that requires a process that wants to bind to ports < 1024 to have elevated privileges. While this was a security feature in the days of dumb terminals, today it is a security anti-feature. (macOS has dropped this requirement as of macOS Mojave.)

On modern Linux systems, you can disable privileged ports like this:

```sh
sudo sysctl -w net.ipv4.ip_unprivileged_port_start=0
```

Or, if you want to cling to ancient historic relics like a conservative to a racist statue, ensure your Node process has the right to bind to so-called ‚Äúprivileged‚Äù ports by issuing the following command before use:

```sh
sudo setcap cap_net_bind_service=+ep $(which node)
```

If you are wrapping your Node app into an executable binary using a module like [Nexe](https://github.com/nexe/nexe), you will have to ensure that every build of your app has that capability set. For an example of how we do this in [Site.js](https://sitejs.org), [see this listing](https://source.ind.ie/site.js/app/blob/master/bin/lib/ensure.js#L124).

## Technical definition

Implements the subset of [RFC 8555](https://tools.ietf.org/html/rfc8555) ‚Äì Automatic Certificate Management Environment (ACME) ‚Äì necessary for a [Node.js](https://nodejs.org) [https](https://nodejs.org/dist/latest-v12.x/docs/api/https.html) server to provision [TLS certificates](https://en.wikipedia.org/wiki/Transport_Layer_Security) from [Let‚Äôs Encrypt](https://letsencrypt.org) using the [HTTP-01 challenge](https://tools.ietf.org/html/rfc8555#section-8.3) on first hit of an HTTPS route via use of the [Server Name Indication](https://en.wikipedia.org/wiki/Server_Name_Indication) (SNI) callback.

## A note on coding conventions

The code uses TC39 class fields with the following naming conventions for private fields:

```js
#property     // safe property access (either via accessor or where property is both safe to get and set)
#_property    // unsafe  property access (should only be used in accessors)
```

(Documenting these here as private class fields ‚Äì ‚Äòhashnames‚Äô ‚Äì are relatively new as of this writing and may not be familiar to some. The use of the underscore to differentiate direct property access from mediated access via an accessor is a project convention.)

## Like this? Fund us!

[Small Technology Foundation](https://small-tech.org) is a tiny, independent not-for-profit.

We exist in part thanks to patronage by people like you. If you share [our vision](https://small-tech.org/about/#small-technology) and want to support our work, please [become a patron or donate to us](https://small-tech.org/fund-us) today and help us continue to exist.

## Copyright

&copy; 2020-present [Aral Balkan](https://ar.al), [Small Technology Foundation](https://small-tech.org).

Let‚Äôs Encrypt is a trademark of the Internet Security Research Group (ISRG). All rights reserved. Node.js is a trademark of Joyent, Inc. and is used with its permission. We are not endorsed by or affiliated with Joyent or ISRG.

## License

[AGPL version 3.0 or later.](https://www.gnu.org/licenses/agpl-3.0.en.html)
