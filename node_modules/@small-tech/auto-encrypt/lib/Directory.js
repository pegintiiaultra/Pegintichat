/**
  Directory

  In order to help clients configure themselves with the right URLs for
  each ACME operation, ACME servers provide a directory object.  This
  should be the only URL needed to configure clients. (RFC Â§7.1.1)

  Copyright Â© 2020 Aral Balkan, Small Technology Foundation.
  License: AGPLv3 or later.
*/

import util from 'util'
import log from './util/log.js'
import Throws from './util/Throws.js'

const throws = new Throws()

export default class Directory {
  directory         = null
  letsEncryptServer = null

  //
  // Factory method access (async).
  //
  static isBeingInstantiatedViaAsyncFactoryMethod = false

  /**
    @param {import('./Configuration.js').default|void} configuration
  */
  static async getInstanceAsync (configuration = throws.ifMissing()) {
    Directory.isBeingInstantiatedViaAsyncFactoryMethod = true
    const directory = new Directory(/** @type {import('./Configuration.js').default} */ (configuration))
    await directory.getUrls()
    return directory
  }

  //
  // Accessors.
  //

  // Directory URLs.
  get keyChangeUrl()      { return this.directory.keyChange  }
  get newAccountUrl()     { return this.directory.newAccount }
  get newNonceUrl()       { return this.directory.newNonce   }
  get newOrderUrl()       { return this.directory.newOrder   }
  get revokeCertUrl()     { return this.directory.revokeCert }
  get termsOfServiceUrl() { return this.directory.meta.termsOfService }
  get websiteUrl()        { return this.directory.meta.website        }
  get renewalInfoUrl()    { return this.directory.renewalInfo         }
  get profiles()          { return this.directory.meta.profiles       }

  //
  // Private.
  //

  /**
    @param {import('./Configuration.js').default} configuration
  */
  constructor(configuration) {
    // Ensure async factory method instantiation.
    if (Directory.isBeingInstantiatedViaAsyncFactoryMethod === false) {
      throws.error(Symbol.for('MustBeInstantiatedViaAsyncFactoryMethodError'), 'Directory')
    }
    Directory.isBeingInstantiatedViaAsyncFactoryMethod = false

    this.letsEncryptServer = configuration.server

    log(`   ðŸ“•    â¨auto-encryptâ© Directory is using endpoint ${this.letsEncryptServer.endpoint}`)
  }

  // (Async) Fetches the latest Urls from the Letâ€™s Encrypt ACME endpoint being used.
  // This will throw if the request fails. Ensure that you catch the error when
  // using it.
  async getUrls() {
    const response = await fetch(this.letsEncryptServer.endpoint)
    if (!response.ok) {
      throw new Error(`HTTP Error: ${response.status} ${response.statusText}`)
    }
    this.directory = await response.json()
  }

  // Custom object description for console output (for debugging).
  [util.inspect.custom] () {
    return `
      # Directory

      Endpoint: ${this.letsEncryptServer.endpoint}

      ## URLs:

      - keyChangeUrl     : ${this.keyChangeUrl}
      - newAccountUrl    : ${this.newAccountUrl}
      - newNonceUrl      : ${this.newNonceUrl}
      - newOrderUrl      : ${this.newOrderUrl}
      - revokeCertUrl    : ${this.revokeCertUrl}
      - termsOfServiceUrl: ${this.termsOfServiceUrl}
      - websiteUrl       : ${this.websiteUrl}
      - renewalInfoUrl   : ${this.renewalInfoUrl}
      - profiles         : ${Object.entries(this.profiles).map(([key, value], index) => `${index > 0 ? ', ' : ''}${key} (${value})`)}
    `
  }
}
