/**
  NewOrderRequest

  Copyright © 2020 Aral Balkan, Small Technology Foundation.
  License: AGPLv3 or later.
*/

import net from 'node:net'
import AcmeRequest from '../AcmeRequest.js'
import Throws from '../util/Throws.js'
const throws = new Throws()

export default class NewOrderRequest extends AcmeRequest {
  /**
    Creates a new order request to start the process of obtaining
    Let’s Encrypt TLS certificates.

    See RFC 8555 § 7.1.3 (Order Objects), 7.4 (Applying for Certificate Issuance)

    @param { import('../Configuration.js').default | void } configuration
    @param { string | void } ariCertId
  */
  async execute (configuration = throws.ifMissing(), ariCertId = throws.ifMissing()) {
    const identifiers = /** @type { import('../Configuration.js').default } */(configuration).domains.map(domain => {
      // Determine whether this is a domain name or an IP address (IPv4 or IPv6)
      return { type: net.isIP(domain) ? 'ip' : 'dns', value: domain} }
    )
    // As of end of December, 2025, Auto Encrypt only supports
    // Let’s Encrypt’s new short-lived profiles.
    // See: https://datatracker.ietf.org/doc/draft-ietf-acme-profiles/
    const payload = { identifiers, profile: 'shortlived' }
    // If this is a renewal, mark the certificate it’s replacing (ARI)
    // See: https://letsencrypt.org/2024/04/25/guide-to-integrating-ari-into-existing-acme-clients/#step-6-indicating-which-certificate-is-replaced-by-this-new-order
    if (ariCertId !== null) {
      payload.replaces = ariCertId
    }
    const response = await super.request('newOrder', payload, /* useKid = */ true, /* successCodes = */ [201])
    return response
  }
}
