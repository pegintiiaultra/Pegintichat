/**
  Automatically provisions and renews Let’s Encrypt™ TLS certificates for Node.js® https servers (as used in @small-tech/https and Kitten.)

  Implements the subset of RFC 8555 – Automatic Certificate Management Environment (ACME) – necessary for a Node.js https server to provision TLS certificates from Let’s Encrypt using the HTTP-01 challenge.

  The certificates are provisioned, if necessary, at time of server creation, prior to server start with hourly renewal checks  and automatic renewals.

  Auto Encrypt uses the new Let’s Encrypt `shortlived` profile *exclusively*,  which means certificates are valid for (and renewed before) 160 hours. This should occur at around the 80 hour mark of the certificate’s lifespan, in accordance with data returned by ACME Renewal Information (ARI).

  Auto Encrypt also implements automatic support for obtaining certificates on IPv4 and IPv6 addresses to enable the use of Web Numbers on the Small Web (see https://ar.al/2025/06/25/web-numbers/).

  Remember that Auto Encrypt is for the Small Web (peer-to-peer Web). You might find it useful for everyday web purposes also but it is specifically focused for Small Web use cases and explicitly does not aim to be a generic or exhaustive ACME client.

  @module @small-tech/auto-encrypt
  @copyright © 2020-present Aral Balkan, Small Technology Foundation.
  @license AGPLv3 or later.
*/

import { Server, ServerOptions } from 'node:https'
import { SecureContext } from 'node:tls'
import { IncomingMessage, ServerResponse } from 'node:http'

import IPAddresses from './lib/IPAddresses.js'
export { IPAddresses }

/**
  Options for creating an AutoEncrypt server. Extends Node’s https.ServerOptions.
*/
export interface AutoEncryptOptions extends ServerOptions {
  /**
    The domains for which to provision and renew certificates.
  */
  domains?: string[]

  /**
    Type of Let’s Encrypt server to use. Use AutoEncrypt.serverType constants.
  */
  serverType?: number

  /**
    Path where settings and certificates will be stored.
  */
  settingsPath?: string

  /**
    Whether to automatically detect and use the machine’s IPv4 address.
  */
  ipv4?: boolean

  /**
    Whether to automatically detect and use the machine’s stable IPv6 addresses.
  */
  ipv6?: boolean

  /**
    If true, only IP addresses (IPv4/IPv6 as requested) are used, ignoring the hostname.
  */
  ipOnly?: boolean
}

/**
  Request listener function signature.
*/
export type RequestListener = (req: IncomingMessage, res: ServerResponse) => void

/**
  Enumeration of Let’s Encrypt server types.
*/
export interface ServerType {
  PRODUCTION: 0
  STAGING: 1
  PEBBLE: 2
  MOCK: 3
}

/**
  Represents a Let’s Encrypt TLS certificate.
*/
export interface Certificate {
  getSecureContext(): Promise<SecureContext | null>
  checkForRenewal(): Promise<void>
  stopCheckingForRenewal(): void
  readonly isProvisioned: boolean
  readonly pem: string | Buffer | Array<string | Buffer> | undefined
}

/**
  Represents a Let’s Encrypt server instance.
*/
export interface LetsEncryptServer {
  readonly type: number
  readonly name: string
  readonly endpoint: string
}

/**
  The monkey-patched https.Server instance returned by AutoEncrypt.
*/
export interface AutoEncryptedServer extends Server {
  listen(...args:any[]): Promise<AutoEncryptedServer>
  async close(): Promise<void>
}

/**
  Auto Encrypt is a static class. Please do not instantiate.

  Use: AutoEncrypt.https.createServer(…)

  @alias module:@small-tech/auto-encrypt
  @hideconstructor
*/
export default class AutoEncrypt {
  static letsEncryptServer: LetsEncryptServer | null
  static defaultDomains   : string[] | null
  static domains          : string[] | null
  static settingsPath     : string | null
  static listener         : RequestListener | null
  static certificate      : Certificate | null

  /**
    Enumeration.

    @static
    @readonly
  */
  static readonly serverType: ServerType

  /**
    By aliasing the https property to the AutoEncrypt static class itself, we enable people to add AutoEncrypt to their existing apps by requiring the module and prefixing their https.createServer(…) line with AutoEncrypt:

    @example import AutoEncrypt from '@small-tech/auto-encrypt'
    const server = AutoEncrypt.https.createServer()

    @static
  */
  static readonly https: typeof AutoEncrypt

  /**
    Automatically manages Let’s Encrypt certificate provisioning and renewal for Node.js https servers using the HTTP-01 challenge on first hit of an HTTPS route via use of the Server Name Indication (SNI) callback.

    @static

    @param {AutoEncryptOptions | RequestListener} [options] Configuration options or a request listener.
    @param {RequestListener} [listener] Optional request listener if options were provided.
    @returns {Promise<AutoEncryptedServer>} The server instance returned by Node’s https.createServer() method.
  */
  static async createServer(options?: AutoEncryptOptions | RequestListener, listener?: RequestListener): Promise<AutoEncryptedServer>

  /**
    Shut Auto Encrypt down. Do this before app exit. Performs necessary clean-up and removes any references that might cause the app to not exit.
  */
  static async shutdown(): Promise<void>

  private constructor()
}
